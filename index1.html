<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiteCase Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://tally.so/widgets/embed.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #ffffff;
            overflow-x: hidden;
        }

        .georgia-font {
            font-family: Georgia, 'Times New Roman', Times, serif;
        }

        .logo-cite {
            background-color: #ffffff;
            color: #000000;
            padding: 0 8px;
        }

        .logo-case {
            background-color: #000000;
            color: #ffffff;
            padding: 0 8px;
        }

        .result-item {
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease-in-out;
        }

        .result-item:hover {
            background-color: #f8fafc;
            transform: translateY(-2px);
        }

        .highlight {
            color: #2563eb;
            font-weight: 700;
            background-color: #eff6ff;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Minimal Spinner */
        .spinner {
            border: 2px solid #e2e8f0;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #000000;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Centering Wrapper */
        .content-wrapper {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        .state-initial {
            justify-content: center;
            padding-top: 0;
        }

        .state-active {
            justify-content: flex-start;
            padding-top: 5vh;
        }

        /* Form Overlay */
        #formOverlay {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .hidden-app {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- Tally Form Overlay -->
    <div id="formOverlay">
        <div class="georgia-font text-4xl md:text-5xl mb-8 select-none flex items-center border-4 border-black inline-flex">
            <span class="logo-cite">Cite</span><span class="logo-case">Case</span>
        </div>
        <p class="text-slate-500 mb-6 font-medium text-sm uppercase tracking-widest">Please complete the form to access the search engine</p>
        <div class="w-full max-w-2xl px-4">
            <!-- Provided Tally Embed Snippet -->
            <iframe data-tally-src="https://tally.so/embed/xXYKv5?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" loading="lazy" width="100%" height="250" frameborder="0" marginheight="0" marginwidth="0" title="null"></iframe>
            <script>
                var d=document,w="https://tally.so/widgets/embed.js",v=function(){"undefined"!=typeof Tally?Tally.loadEmbeds():d.querySelectorAll("iframe[data-tally-src]:not([src])").forEach((function(e){e.src=e.dataset.tallySrc}))};if("undefined"!=typeof Tally)v();else if(d.querySelector('script[src="'+w+'"]')==null){var s=d.createElement("script");s.src=w,s.onload=v,s.onerror=v,d.body.appendChild(s);}
            </script>
        </div>
    </div>

    <!-- Main Content Wrapper (Hidden initially) -->
    <div id="mainWrapper" class="content-wrapper w-full flex flex-col items-center state-initial flex-grow min-h-screen hidden-app">
        
        <!-- Search Header -->
        <div class="w-full max-w-4xl px-6 pb-8 flex flex-col items-center text-center mt-24">
            <!-- Logo Section -->
            <div class="georgia-font text-5xl md:text-6xl mb-12 select-none flex items-center border-4 border-black inline-flex">
                <span class="logo-cite">Cite</span><span class="logo-case">Case</span>
            </div>
            
            <div class="w-full relative group max-w-2xl">
                <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-black"></i>
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search Any Supreme Court Case Or Neutral Citation" 
                    class="w-full pl-14 pr-6 py-5 bg-white border-2 border-slate-200 focus:border-black rounded-full outline-none transition-all text-xl shadow-sm hover:shadow-md"
                >
            </div>
            
            <div id="statusText" class="mt-6 text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">
                Connecting to archives...
            </div>
        </div>

        <!-- Results Area -->
        <main class="w-full max-w-3xl px-6 pb-20">
            <!-- Initial Loader -->
            <div id="loader" class="flex flex-col items-center gap-3 py-10 text-slate-500">
                <div class="spinner"></div>
                <span class="text-sm font-medium" id="loadingMessage">Indexing global legal records...</span>
            </div>

            <!-- No Results -->
            <div id="noResults" class="hidden py-20 text-center">
                <div class="text-slate-200 mb-4">
                    <i class="fas fa-magnifying-glass text-6xl"></i>
                </div>
                <p class="text-slate-500 font-semibold text-lg">No matches found</p>
                <p class="text-slate-400 text-sm mt-1">Refine your search term or try a specific year.</p>
            </div>

            <!-- Result List -->
            <div id="resultsList" class="space-y-2">
                <!-- Results injected here -->
            </div>
        </main>
    </div>

    <!-- Footer / Acknowledgment (Hidden initially) -->
    <footer id="mainFooter" class="w-full py-8 text-center text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em] hidden-app">
        Acknowledgment: SCI.Gov.In , commonlii.org
    </footer>

    <script>
        const DATA_URLS = [
            'https://raw.githubusercontent.com/citecase/lii/main/2009-14.md',
            'https://raw.githubusercontent.com/citecase/lii/refs/heads/main/1950-1992-6.md',
            'https://raw.githubusercontent.com/citecase/lii/refs/heads/main/1950-1992-5.md',
            'https://raw.githubusercontent.com/citecase/lii/refs/heads/main/1991-2008.md',
            'https://raw.githubusercontent.com/citecase/lii/main/1991-2008-2.md',
            'https://raw.githubusercontent.com/citecase/lii/refs/heads/main/2015-2023.md'
        ];

        let allCases = [];
        const formOverlay = document.getElementById('formOverlay');
        const mainWrapper = document.getElementById('mainWrapper');
        const mainFooter = document.getElementById('mainFooter');
        const searchInput = document.getElementById('searchInput');
        const resultsList = document.getElementById('resultsList');
        const loader = document.getElementById('loader');
        const noResults = document.getElementById('noResults');
        const statusText = document.getElementById('statusText');
        const loadingMessage = document.getElementById('loadingMessage');

        // Tally Form Integration Logic
        window.addEventListener('message', (event) => {
            // Check for both string and object message types from Tally
            if (event.data && (
                (typeof event.data === 'string' && event.data.includes('Tally.FormSubmitted')) ||
                (event.data.type === 'Tally.FormSubmitted')
            )) {
                unlockApp();
            }
        });

        function unlockApp() {
            formOverlay.style.opacity = '0';
            setTimeout(() => {
                formOverlay.style.display = 'none';
                mainWrapper.classList.remove('hidden-app');
                mainFooter.classList.remove('hidden-app');
                searchInput.focus();
                init(); // Start loading data only after form is submitted
            }, 500);
        }

        function cleanTitle(text) {
            if (!text) return "";
            return text
                .replace(/[#*\\_]/g, '')
                .replace(/\[/g, '')
                .replace(/\]/g, '')
                .replace(/^\s*\d+[\.\)]\s*/, '')
                .replace(/\(http\S+\.(html|pdf)\)/gi, '')
                .replace(/http\S+\.(html|pdf)/gi, '')
                .trim();
        }

        function extractUrl(line) {
            const urlRegex = /https?:\/\/[^\s\)]+\.(html|pdf)/gi;
            const match = line.match(urlRegex);
            return match ? match[0] : null;
        }

        async function init() {
            let loadedCount = 0;
            const fetchPromises = DATA_URLS.map(async (url) => {
                try {
                    const response = await fetch(url + '?t=' + new Date().getTime());
                    if (!response.ok) return "";
                    const text = await response.text();
                    loadedCount++;
                    loadingMessage.innerText = `Loading archives (${loadedCount}/${DATA_URLS.length})...`;
                    return text;
                } catch (err) {
                    console.error("Error fetching " + url, err);
                    return "";
                }
            });

            try {
                const results = await Promise.all(fetchPromises);
                results.forEach(content => parseData(content));
                
                loader.classList.add('hidden');
                statusText.innerText = `${allCases.length.toLocaleString()} total cases indexed`;
            } catch (err) {
                statusText.innerText = "Network Error";
                loader.classList.add('hidden');
                console.error(err);
            }
        }

        function parseData(content) {
            if (!content) return;
            const lines = content.split('\n');

            const batch = lines
                .map(line => line.trim())
                .filter(line => line.length > 5 && !line.startsWith('!['))
                .map(line => {
                    const url = extractUrl(line);
                    if (!url) return null;

                    const titleOnly = line.replace(url, '').replace(/[()]/g, '');
                    
                    return { 
                        title: cleanTitle(titleOnly), 
                        url: url.trim()
                    };
                })
                .filter(item => item !== null && item.title.length > 0);
            
            allCases = [...allCases, ...batch];
        }

        function renderResults(cases, query = '') {
            resultsList.innerHTML = '';
            
            if (cases.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');

            const fragment = document.createDocumentFragment();
            cases.forEach(item => {
                const container = document.createElement('a');
                container.href = item.url;
                container.target = "_blank";
                container.className = `result-item block p-6 bg-white border-2 border-transparent hover:border-slate-100 rounded-2xl cursor-pointer text-center`;
                
                let displayTitle = item.title;
                if (query) {
                    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    displayTitle = item.title.replace(regex, '<span class="highlight">$1</span>');
                }

                container.innerHTML = `
                    <div class="text-base md:text-lg text-slate-800 font-semibold leading-relaxed">
                        ${displayTitle}
                    </div>
                `;
                fragment.appendChild(container);
            });
            resultsList.appendChild(fragment);
        }

        function handleSearch(val) {
            const query = val.toLowerCase().trim();
            
            if (query.length < 4) {
                resultsList.innerHTML = '';
                noResults.classList.add('hidden');
                mainWrapper.classList.remove('state-active');
                mainWrapper.classList.add('state-initial');
                statusText.innerText = `${allCases.length.toLocaleString()} total cases indexed`;
                return;
            }

            mainWrapper.classList.remove('state-initial');
            mainWrapper.classList.add('state-active');

            const filtered = allCases.filter(c => 
                c.title.toLowerCase().includes(query)
            );

            statusText.innerText = `${filtered.length} matches found`;
            renderResults(filtered.slice(0, 150), query);
        }

        searchInput.addEventListener('input', (e) => {
            handleSearch(e.target.value);
        });
    </script>
</body>
</html>
